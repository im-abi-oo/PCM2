name: Build Saino COC (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.11'
  SCRIPT: 'PCM2.py'
  ICON_PNG: 'ICON.PNG'
  ICON_ICO: 'icon_for_nuitka.ico'
  EXE_NAME: 'Saino COC.exe'
  DIST_DIR: 'dist'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository (stable)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: false

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Verify required files
      shell: powershell
      run: |
        if (!(Test-Path $env:SCRIPT)) { Write-Error "Missing $env:SCRIPT"; exit 1 }
        if (!(Test-Path $env:ICON_PNG)) { Write-Error "Missing $env:ICON_PNG"; exit 1 }
        Write-Output "Required files found"

    - name: Install Python build dependencies
      shell: powershell
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --upgrade nuitka
        pip install PySide6 pillow img2pdf PyMuPDF pypdf patool

    - name: Create ICO from PNG (PowerShell-safe)
      shell: powershell
      run: |
        $code = @'
from PIL import Image

png = r"${{ env.ICON_PNG }}"
ico = r"${{ env.ICON_ICO }}"

img = Image.open(png)
if img.mode not in ("RGB", "RGBA"):
    img = img.convert("RGBA")

sizes = [(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)]
img.save(ico, format="ICO", sizes=sizes)

print("ICO created:", ico)
'@
        Set-Content -Path make_icon.py -Value $code -Encoding UTF8
        python make_icon.py

    - name: Force app_name to Saino COC (optional patch)
      shell: powershell
      run: |
        $file = Get-Item $env:SCRIPT
        $text = Get-Content -Raw $file.FullName
        $patched = [regex]::Replace(
          $text,
          '("app_name"\s*:\s*)"(.*?)"',
          '$1"Saino COC"'
        )
        if ($patched -ne $text) {
          Set-Content $file.FullName $patched -Encoding UTF8
          Write-Output "app_name patched"
        } else {
          Write-Output "No app_name field found"
        }

    - name: Show tool versions
      shell: powershell
      run: |
        python --version
        python -c "import nuitka; print('nuitka', nuitka.__version__)"

    - name: Compile with Nuitka (onefile EXE)
      shell: powershell
      run: |
        if (!(Test-Path $env:DIST_DIR)) {
          New-Item -ItemType Directory -Path $env:DIST_DIR | Out-Null
        }

        python -m nuitka `
          --standalone `
          --onefile `
          --lto=yes `
          --enable-plugin=pyside6 `
          --windows-disable-console `
          --windows-icon-from-ico=$env:ICON_ICO `
          --assume-yes-for-downloads `
          --output-dir=$env:DIST_DIR `
          $env:SCRIPT

    - name: Rename final EXE
      shell: powershell
      run: |
        $exe = Get-ChildItem $env:DIST_DIR -Filter *.exe -Recurse | Select-Object -First 1
        if (!$exe) { Write-Error "EXE not found"; exit 1 }
        $dest = Join-Path $env:DIST_DIR $env:EXE_NAME
        Copy-Item $exe.FullName $dest -Force
        Write-Output "Final EXE created: $dest"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: SainoCOC-Windows
        path: ${{ env.DIST_DIR }}/**
