name: Build Saino COC (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  SCRIPT: 'PCM2.py'                   # <-- اسم فایل پایتون ورودی (مطمئن شو همین اسم در ریپو هست)
  ICON_PNG: 'ICON.PNG'                # <-- آیکون PNG که توی ریپو قرار میدی
  ICON_ICO: 'icon_for_nuitka.ico'     # <-- فایل .ico ای که از PNG ساخته میشه
  EXE_NAME: 'Saino COC.exe'           # <-- اسم نهایی EXE که میخوای
  DIST_DIR: 'dist'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Ensure source files exist
      shell: powershell
      run: |
        if (-not (Test-Path -Path $env:SCRIPT)) { Write-Error "Missing $env:SCRIPT in repo root"; exit 1 }
        if (-not (Test-Path -Path $env:ICON_PNG)) { Write-Error "Missing $env:ICON_PNG in repo root"; exit 1 }
        Write-Output "Found $env:SCRIPT and $env:ICON_PNG"

    - name: Install build dependencies (Nuitka, PySide6, Pillow, extras)
      shell: powershell
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --upgrade nuitka
        pip install "PySide6"
        pip install pillow img2pdf PyMuPDF pypdf patool

    - name: Create .ico from ICON.PNG (Pillow)
      shell: powershell
      run: |
        python - <<'PY'
        from PIL import Image
        import sys
        png = r"${{ env.ICON_PNG }}"
        ico = r"${{ env.ICON_ICO }}"
        img = Image.open(png)
        # ensure reasonable icon sizes (Nuitka / Windows use common sizes). We produce multi-size icon.
        sizes = [(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)]
        # convert to RGBA if necessary
        if img.mode not in ("RGBA","RGB"):
            img = img.convert("RGBA")
        img.save(ico, format='ICO', sizes=sizes)
        print("Saved ICO:", ico)
        PY

    - name: Optionally force app name inside source to 'Saino COC'
      # This step replaces any "app_name": "..." in the source with "Saino COC"
      shell: powershell
      run: |
        $file = Get-Item -Path $env:SCRIPT
        $txt = Get-Content -Raw -LiteralPath $file.FullName
        # regex replace occurrences like "app_name": "something"
        $new = [regex]::Replace($txt, '("app_name"\s*:\s*)"(.*?)"', '$1"Saino COC"')
        if ($new -ne $txt) {
          Set-Content -LiteralPath $file.FullName -Value $new -Encoding UTF8
          Write-Output "Patched app_name in $($file.Name) -> Saino COC"
        } else {
          Write-Output "No app_name key found (or already set)."
        }

    - name: Show Python & Nuitka versions
      shell: powershell
      run: |
        python --version
        python -c "import nuitka, sys; print('nuitka', getattr(nuitka,'__version__', 'unknown'))"

    - name: Compile PCM2.py with Nuitka (standalone, onefile) 
      shell: powershell
      run: |
        if (!(Test-Path -Path $env:DIST_DIR)) { New-Item -ItemType Directory -Path $env:DIST_DIR | Out-Null }
        python -m nuitka `
          --standalone `
          --onefile `
          --lto=yes `
          --enable-plugin=pyside6 `
          --windows-disable-console `
          --windows-icon-from-ico=$env:ICON_ICO `
          --assume-yes-for-downloads `
          --output-dir=%DIST_DIR% `
          $env:SCRIPT

    - name: Locate produced exe and rename/copy to desired name
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path $env:DIST_DIR -Filter *.exe -Recurse | Select-Object -First 1
        if ($null -eq $exe) {
          Write-Error "No EXE found in $env:DIST_DIR. Build probably failed."
          exit 1
        }
        $dest = Join-Path -Path $env:DIST_DIR -ChildPath $env:EXE_NAME
        Copy-Item -Path $exe.FullName -Destination $dest -Force
        Write-Output "Produced EXE: $dest"
        Get-ChildItem -Path $env:DIST_DIR -File | ForEach-Object { Write-Output $_.Name }

    - name: Upload dist folder (includes final EXE)
      uses: actions/upload-artifact@v4
      with:
        name: SainoCOC-build
        path: ${{ env.DIST_DIR }}/**
