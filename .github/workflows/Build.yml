name: Build Saino COC (Windows)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.11'
  SCRIPT: 'PCM2.py'
  ICON_PNG: 'ICON.PNG'
  ICON_ICO: 'icon_for_nuitka.ico'
  EXE_NAME: 'Saino COC.exe'
  DIST_DIR: 'dist'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: false

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      shell: powershell
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install nuitka PySide6 pillow img2pdf PyMuPDF pypdf patool

    - name: Verify files
      shell: powershell
      run: |
        if (!(Test-Path $env:SCRIPT)) { Write-Error "Missing $env:SCRIPT"; exit 1 }
        if (!(Test-Path $env:ICON_PNG)) { Write-Error "Missing $env:ICON_PNG"; exit 1 }

    - name: Create ICO from PNG
      shell: powershell
      run: |
        $py = @'
from PIL import Image
png = r"${{ env.ICON_PNG }}"
ico = r"${{ env.ICON_ICO }}"
img = Image.open(png)
if img.mode not in ("RGB","RGBA"):
    img = img.convert("RGBA")
sizes=[(256,256),(128,128),(64,64),(48,48),(32,32),(16,16)]
img.save(ico, format="ICO", sizes=sizes)
print("ICO created:", ico)
'@
        Set-Content make_icon.py $py -Encoding UTF8
        python make_icon.py

    - name: Patch app_name (safe)
      shell: powershell
      run: |
        $t = Get-Content -Raw $env:SCRIPT
        $n = [regex]::Replace($t,'("app_name"\s*:\s*)"(.*?)"','$1"Saino COC"')
        if ($n -ne $t) { Set-Content $env:SCRIPT $n -Encoding UTF8 }

    - name: Compile with Nuitka
      shell: powershell
      run: |
        if (!(Test-Path $env:DIST_DIR)) { New-Item -ItemType Directory $env:DIST_DIR | Out-Null }
        python -m nuitka `
          --standalone `
          --onefile `
          --enable-plugin=pyside6 `
          --windows-disable-console `
          --windows-icon-from-ico=$env:ICON_ICO `
          --assume-yes-for-downloads `
          --output-dir=$env:DIST_DIR `
          $env:SCRIPT

    - name: Rename EXE
      shell: powershell
      run: |
        $exe = Get-ChildItem $env:DIST_DIR -Filter *.exe -Recurse | Select-Object -First 1
        if (!$exe) { Write-Error "EXE not found"; exit 1 }
        Copy-Item $exe.FullName (Join-Path $env:DIST_DIR $env:EXE_NAME) -Force

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SainoCOC-Windows
        path: dist/**
